PR-13.md — Greentic-dev E2E: component → pack → flow edits → run

Goal: Add an integration test that proves a developer can use greentic-dev to: scaffold a new component, add sample code, generate a new pack, build a complex flow with multiple components, insert the new component between existing steps using add-step, validate/build the pack, and run it with greentic-dev.

Scope

Test CLI workflow, not internals.

Test must run in CI (Linux) and locally.

No interactive prompts in CI (--yes / --non-interactive or piped input).

What to build in the test

Create a temp workspace

Use a temp dir (e.g. target/integration/pr13-*) and ensure cleanup.

All commands run with cwd set to this temp dir.

Scaffold a new component via greentic-dev

greentic-dev component new <name> (or whatever the current command is)

Add a tiny implementation (sample code) that produces a deterministic output:

Example behavior: takes an input string and returns "HELLO::<input>" or appends a known suffix.

Ensure it builds to a wasm artifact (whatever build command greentic-dev uses).

Install/register the component via greentic-dev

Use the supported path:

either install to local store/cache (greentic-dev component install ...)

or add it to the workspace registry used by greentic-dev.

Assert it appears in greentic-dev component list (or equivalent).

Generate a new pack via greentic-dev

greentic-dev pack new <pack_name>

Add 3 components to the pack:

component-A (existing sample component in fixtures or generated)

component-B (existing sample component)

newly generated component from step 2

Create a complex flow with multiple steps

Generate a messaging flow (or a simple flow type used in tests) with:

Step 1: A → transforms input

Step 2: B → transforms output

Confirm the flow compiles/validates before insertion.

Insert the new component between two existing steps

Use greentic-dev flow add-step ... --before/--after (or supported syntax)

Insert the new component between step1 and step2.

Assert the resulting flow step order is [A, NEW, B] using:

greentic-dev flow show / flow print / exported YAML inspection

Validate and build the pack

greentic-dev pack validate (and/or packc verify if greentic-dev delegates)

greentic-dev pack build to produce .gtpack

Assert artifact exists and is non-empty.

Run the pack with greentic-dev

greentic-dev pack run <pack> (or greentic-dev run ...)

Provide a deterministic input payload to the flow.

Assert output equals the expected composed transformation:

expected: B(NEW(A(input)))

Capture logs and assert key lines.

Test structure

Add a new integration test file:

tests/e2e_greentic_dev_component_pack_flow.rs (or tests/pr13_greentic_dev_e2e.rs)

Use a helper to run CLI commands:

Command::new("greentic-dev")

capture stdout/stderr

print on failure

Make the test resilient:

avoid depending on network unless explicitly allowed

pin versions/paths via env vars in CI

use --json outputs if CLI supports it (preferable to parsing text)

CI wiring

Ensure CI builds/installs greentic-dev first (from workspace or released binary).

Run the test after cargo test or as a dedicated job:

cargo test -p greentic-integration --test pr13_greentic_dev_e2e -- --nocapture

Acceptance criteria

A single test proves the complete developer journey:

component scaffold + sample code + build

component install/register

pack scaffold

complex flow created

add-step inserts new component between existing steps

pack validate + build produces gtpack

pack run produces expected output