# PR-07 â€” E2E config+secrets precedence test (fail missing secret, then succeed)

## Goal
High-confidence proof that:
- missing secrets fail with structured, helpful remediation
- once secrets are provided, same scenario succeeds
- precedence rules are respected (cli > env > project > user > defaults)

## Scope
One scenario, two phases:
1) run with missing secret -> assert structured failure
2) inject secret -> rerun -> assert success

## Implementation Plan
1) Add fixture config layers:
   - `fixtures/config/precedence/project.toml`
   - `fixtures/config/precedence/user.toml`
   - `.env` fixture (optional)
2) Add fixture secrets template (not real secrets):
   - `fixtures/secrets/precedence/<keys>.json`
3) Add helper `env.apply_config_layers(...)`
4) Add helper `env.write_secret(uri, value)`
5) Add E2E scenario:
   - install pack that declares `secret_requirements`
   - start flow requiring secret
   - assert error includes:
     - missing keys list
     - remediation command/hint
   - write secret
   - rerun
   - assert success result

## Acceptance Criteria
- Both phases validated.
- Provenance/debug output stored in artifacts.

## Routine actions pre-authorized
- Add small utilities to print config explain output into artifacts.
